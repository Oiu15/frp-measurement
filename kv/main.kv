#:kivy 2.3.0

# ----------------- Home -----------------

<HomeScreen>:
    name: "home"
    MDBoxLayout:
        orientation: "vertical"

        MDTopAppBar:
            title: "FRP Pipe - Home"
            elevation: 4
            left_action_items: [["menu", lambda x: None]]
            right_action_items: [["cog", lambda x: setattr(app.root, "current", "settings")]]

        MDBoxLayout:
            orientation: "horizontal"
            padding: "24dp"
            spacing: "24dp"

            MDCard:
                orientation: "vertical"
                padding: "24dp"
                size_hint_x: 0.4
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Status"
                    theme_text_color: "Secondary"
                    font_style: "Subtitle1"

                MDLabel:
                    id: status_label
                    text: "READY"
                    font_style: "H4"
                    halign: "left"
                    theme_text_color: "Custom"
                    text_color: 0.4, 1, 0.5, 1

                Widget:
                    size_hint_y: 0.2

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "12dp"
                    size_hint_y: None
                    height: "48dp"

                    MDRaisedButton:
                        text: "Start Auto"
                        size_hint_x: 0.5
                        on_release: app.root.current = "auto"

                    MDRaisedButton:
                        text: "Manual"
                        size_hint_x: 0.5
                        on_release: app.root.current = "manual"

            MDCard:
                orientation: "vertical"
                padding: "24dp"
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Live Values"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"

                GridLayout:
                    cols: 2
                    padding: [0, "12dp", 0, 0]
                    row_default_height: "40dp"
                    spacing: "8dp"

                    MDLabel:
                        text: "Outer Diameter"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: outer_value
                        text: "0.00 mm"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: 0.49, 0.88, 1, 1

                    MDLabel:
                        text: "Inner Diameter"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: inner_value
                        text: "0.00 mm"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: 0.49, 0.88, 1, 1

                    MDLabel:
                        text: "Angle"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: angle_value
                        text: "0.0 °"
                        theme_text_color: "Primary"

                    MDLabel:
                        text: "Slide Pos."
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: slide_value
                        text: "0.0 mm"
                        theme_text_color: "Primary"

# ----------------- PlotWidget -----------------

<LivePlotWidget>:
    canvas.before:
        Color:
            rgba: 0, 0, 0, 1    # 黑色背景
        Rectangle:
            pos: self.pos
            size: self.size

    canvas.after:
        Color:
            rgba: 0.49, 0.88, 1, 1   # 青色：外径
        Line:
            points: self.outer_points
            width: 1.5

        Color:
            rgba: 0.8, 0.4, 1, 1     # 紫色：内径
        Line:
            points: self.inner_points
            width: 1.2
# ----------------- Auto -----------------

<AutoMeasureScreen>:
    name: "auto"

    MDBoxLayout:
        orientation: "vertical"

        # 顶部工具栏
        MDTopAppBar:
            title: "FRP Pipe - Auto Measure"
            elevation: 4
            left_action_items: [["arrow-left", lambda x: setattr(app.root, "current", "home")]]
            right_action_items: [["play-circle", lambda x: None]]

        # 下面是真正的内容区（水平三列）
        MDBoxLayout:
            orientation: "horizontal"
            padding: dp(16)
            spacing: dp(16)

            # -------- 左侧：工艺步骤 --------
            MDCard:
                orientation: "vertical"
                size_hint_x: 0.25
                padding: dp(8)
                radius: dp(12)
                md_bg_color: 0.08, 0.08, 0.08, 1

                MDLabel:
                    text: "Auto Sequence"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"
                    size_hint_y: None
                    height: dp(32)

                MDLabel:
                    id: step_lbl_1
                    text: "1 · Home axes"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_2
                    text: "2 · Move to Edge 1"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_3
                    text: "3 · Move to Edge 2"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_4
                    text: "4 · Position @Measure"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_5
                    text: "5 · Rotate & Acquire"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_6
                    text: "6 · Compute Result"
                    theme_text_color: "Secondary"

                MDLabel:
                    id: step_lbl_7
                    text: "7 · Return / Standby"
                    theme_text_color: "Secondary"

            # -------- 中间：实时数据 & 曲线 --------
            MDCard:
                orientation: "vertical"
                padding: "16dp"
                size_hint_x: 0.35
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Live Data"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"
                    size_hint_y: None
                    height: dp(32)

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: self.minimum_height
                    row_default_height: dp(30)
                    row_force_default: True

                    MDLabel:
                        text: "Outer"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: auto_outer_value
                        text: "152.00 mm"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: 0.49, 0.88, 1, 1

                    MDLabel:
                        text: "Inner"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: auto_inner_value
                        text: "76.00 mm"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: 1, 0.3, 1, 1

                    MDLabel:
                        text: "Angle"
                        theme_text_color: "Secondary"
                    MDLabel:
                        id: auto_angle
                        text: "0.0 °"
                        theme_text_color: "Primary"

                FloatLayout:
                    size_hint_y: 0.55

                    # 曲线本体
                    LivePlotWidget:
                        id: live_plot
                        size_hint: 1, 1
                        pos_hint: {"x": 0, "y": 0}

                    # 图例 Overlay
                    MDBoxLayout:
                        id: legend
                        orientation: "horizontal"
                        spacing: dp(10)
                        padding: dp(8)
                        size_hint: None, None
                        height: self.minimum_height
                        width: self.minimum_width
                        pos_hint: {"right": 0.98, "top": 0.98}
                        md_bg_color: 0.0, 0.0, 0.0, 0.4
                        radius: [8, 8, 8, 8]

                        # Outer
                        MDIcon:
                            icon: "circle"
                            theme_text_color: "Custom"
                            text_color: 0.49, 0.88, 1, 1   # 外径线颜色
                            font_size: dp(12)
                            size_hint: None, None
                            size: dp(14), dp(14)

                        Label:
                            text: "Outer"
                            color: 1, 1, 1, 1
                            size_hint: None, None
                            font_size: sp(12)
                            text_size: None, None
                            size: self.texture_size

                        Widget:
                            size_hint_x: None
                            width: dp(4)

                        # Inner
                        MDIcon:
                            icon: "circle"
                            theme_text_color: "Custom"
                            text_color: 1, 0.3, 1, 1   # 内径线颜色
                            font_size: dp(12)
                            size_hint: None, None
                            size: dp(14), dp(14)

                        Label:
                            text: "Inner"
                            color: 1, 1, 1, 1
                            size_hint: None, None
                            font_size: sp(12)
                            text_size: None, None
                            size: self.texture_size

            # -------- 右侧：Servos / IO --------
            MDCard:
                orientation: "vertical"
                padding: "16dp"
                size_hint_x: 0.35
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Servos / IO"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"
                    size_hint_y: None
                    height: dp(32)

                # 这里保留你原来的内容（伺服状态、PLC 状态等）
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: self.minimum_height
                    row_default_height: dp(24)
                    row_force_default: True

                    MDLabel:
                        text: "Servo A"
                        theme_text_color: "Secondary"
                    MDLabel:
                        text: "ON"
                        theme_text_color: "Custom"
                        text_color: 0.4, 1, 0.5, 1

                    MDLabel:
                        text: "Servo B"
                        theme_text_color: "Secondary"
                    MDLabel:
                        text: "ON"
                        theme_text_color: "Custom"
                        text_color: 0.4, 1, 0.5, 1

                    MDLabel:
                        text: "Servo C"
                        theme_text_color: "Secondary"
                    MDLabel:
                        text: "ON"
                        theme_text_color: "Custom"
                        text_color: 0.4, 1, 0.5, 1

                    MDLabel:
                        text: "PLC"
                        theme_text_color: "Secondary"
                    MDLabel:
                        text: "OK"
                        theme_text_color: "Custom"
                        text_color: 0.4, 1, 0.5, 1
# ----------------- Manual -----------------

<ManualScreen>:
    name: "manual"
    MDBoxLayout:
        orientation: "vertical"

        MDTopAppBar:
            title: "FRP Pipe - Manual"
            elevation: 4
            left_action_items: [["arrow-left", lambda x: setattr(app.root, "current", "home")]]

        MDBoxLayout:
            orientation: "horizontal"
            padding: "24dp"
            spacing: "24dp"

            # ---------- 左：直线轴 ----------
            MDCard:
                orientation: "vertical"
                padding: "24dp"
                size_hint_x: 0.5
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Linear Axes"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"

                Widget:
                    size_hint_y: 0.03

                MDLabel:
                    text: "Step (mm)"
                    theme_text_color: "Secondary"
                    size_hint_y: None
                    height: dp(24)

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDSlider:
                        id: linear_step_slider
                        min: 0.1
                        max: 10.0
                        value: 0.5
                        step: 0.1
                        on_value: root.on_linear_step_slider(self.value)

                    MDLabel:
                        id: linear_step_label
                        text: "0.5 mm"
                        theme_text_color: "Secondary"
                        size_hint_x: None
                        width: dp(80)

                Widget:
                    size_hint_y: 0.05

                # ---- 外径滑台 ----
                MDLabel:
                    text: "OD Slide"
                    theme_text_color: "Secondary"

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDRaisedButton:
                        text: "OD-"
                        on_release: root.jog_od_neg()

                    MDRaisedButton:
                        text: "OD+"
                        on_release: root.jog_od_pos()

                    MDRaisedButton:
                        text: "Home"
                        on_release: root.home_od()

                    MDLabel:
                        id: od_pos_label
                        text: "0.0 mm"
                        theme_text_color: "Custom"
                        halign: "right"

                Widget:
                    size_hint_y: 0.02

                # ---- 内径滑台 ----
                MDLabel:
                    text: "ID Slide"
                    theme_text_color: "Secondary"

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDRaisedButton:
                        text: "ID-"
                        on_release: root.jog_id_neg()

                    MDRaisedButton:
                        text: "ID+"
                        on_release: root.jog_id_pos()

                    MDRaisedButton:
                        text: "Home"
                        on_release: root.home_id()

                    MDLabel:
                        id: id_pos_label
                        text: "0.0 mm"
                        theme_text_color: "Custom"
                        halign: "right"

                Widget:
                    size_hint_y: 0.02

                # ---- 内径测头伸缩 ----
                MDLabel:
                    text: "ID Head Extend"
                    theme_text_color: "Secondary"

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDRaisedButton:
                        text: "In"
                        on_release: root.jog_head_in()

                    MDRaisedButton:
                        text: "Out"
                        on_release: root.jog_head_out()

                    MDRaisedButton:
                        text: "Home"
                        on_release: root.home_head()

                    MDLabel:
                        id: head_pos_label
                        text: "0.0 mm"
                        theme_text_color: "Custom"
                        halign: "right"

            # ---------- 右：旋转轴 ----------
            MDCard:
                orientation: "vertical"
                padding: "24dp"
                size_hint_x: 0.5
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Rotary Axes"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"

                Widget:
                    size_hint_y: 0.03

                MDLabel:
                    text: "Step (deg)"
                    theme_text_color: "Secondary"
                    size_hint_y: None
                    height: dp(24)

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDSlider:
                        id: rot_step_slider
                        min: 1
                        max: 90
                        value: 5
                        step: 1
                        on_value: root.on_rot_step_slider(self.value)

                    MDLabel:
                        id: rot_step_label
                        text: "5.0 °"
                        theme_text_color: "Secondary"
                        size_hint_x: None
                        width: dp(80)

                Widget:
                    size_hint_y: 0.05

                # ---- 主旋转电机 ----
                MDLabel:
                    text: "Main Pipe Rotate"
                    theme_text_color: "Secondary"

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDRaisedButton:
                        text: "CCW"
                        on_release: root.jog_main_ccw()

                    MDRaisedButton:
                        text: "CW"
                        on_release: root.jog_main_cw()

                    MDRaisedButton:
                        text: "Home"
                        on_release: root.home_main_rot()

                    MDLabel:
                        id: main_angle_label
                        text: "0.0 °"
                        theme_text_color: "Custom"
                        halign: "right"

                Widget:
                    size_hint_y: 0.02

                # ---- 从旋转电机 ----
                MDLabel:
                    text: "Aux Rotate"
                    theme_text_color: "Secondary"

                MDBoxLayout:
                    orientation: "horizontal"
                    spacing: "8dp"
                    size_hint_y: None
                    height: dp(40)

                    MDRaisedButton:
                        text: "CCW"
                        on_release: root.jog_aux_ccw()

                    MDRaisedButton:
                        text: "CW"
                        on_release: root.jog_aux_cw()

                    MDRaisedButton:
                        text: "Home"
                        on_release: root.home_aux_rot()

                    MDLabel:
                        id: aux_angle_label
                        text: "0.0 °"
                        theme_text_color: "Custom"
                        halign: "right"
# ----------------- Settings -----------------

<SettingsScreen>:
    name: "settings"
    MDBoxLayout:
        orientation: "vertical"
        padding: dp(16)
        spacing: dp(16)

        MDTopAppBar:
            title: "Settings"
            left_action_items: [["arrow-left", lambda x: app.go_home()]]

        MDBoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            MDTextField:
                id: plc_ip_field
                hint_text: "PLC IP Address"
                text: "192.168.0.10"

            MDTextField:
                id: plc_port_field
                hint_text: "PLC Port"
                text: "502"
                input_filter: "int"

            MDTextField:
                id: samples_field
                hint_text: "Samples per revolution"
                text: "180"
                input_filter: "int"

        MDBoxLayout:
            size_hint_y: None
            height: dp(48)
            spacing: dp(12)
            padding: 0, dp(8), 0, 0

            Widget:
            MDRaisedButton:
                text: "Apply"
                on_release: root.on_apply_button()


# ----------------- Result -----------------

<ResultScreen>:
    name: "result"
    MDBoxLayout:
        orientation: "vertical"
        padding: dp(16)
        spacing: dp(16)

        MDTopAppBar:
            title: "Result"
            left_action_items: [["arrow-left", lambda x: app.go_home()]]

        MDBoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            # 表格区域
            MDCard:
                orientation: "vertical"
                padding: dp(8)
                radius: dp(12)
                md_bg_color: 0.08, 0.08, 0.08, 1
                MDLabel:
                    text: "Measurement Report"
                    theme_text_color: "Secondary"
                    font_style: "Subtitle1"
                    padding_y: dp(4)
                MDSeparator:
                MDBoxLayout:
                    id: result_table_container   # ← Python 里会拿这个 id
                    orientation: "vertical"

            # 下面可以保留简单的结果总结
            MDBoxLayout:
                size_hint_y: None
                height: dp(40)
                spacing: dp(12)

                MDLabel:
                    id: res_ok_label
                    text: "OK"
                    font_style: "H6"
                    theme_text_color: "Custom"
                    text_color: (0, 1, 0, 1)

                Widget:


# ----------------- Alarm -----------------

<AlarmScreen>:
    name: "alarm"
    MDBoxLayout:
        orientation: "vertical"

        MDTopAppBar:
            title: "FRP Pipe - Alarms"
            elevation: 4
            left_action_items: [["arrow-left", lambda x: setattr(app.root, "current", "home")]]

        MDBoxLayout:
            padding: "24dp"

            MDCard:
                orientation: "vertical"
                padding: "24dp"
                radius: [16, 16, 16, 16]
                md_bg_color: 0.17, 0.19, 0.21, 1

                MDLabel:
                    text: "Alarm List (TODO)"
                    theme_text_color: "Secondary"

# ----------------- Root ScreenManager -----------------

ScreenManager:
    HomeScreen:
    AutoMeasureScreen:
    ManualScreen:
    SettingsScreen:
    ResultScreen:
    AlarmScreen:
